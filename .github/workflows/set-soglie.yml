name: Set Soglie Manuale

on:
  workflow_dispatch:
    inputs:
      chat_id:
        description: "Il tuo chat_id Telegram (es. 32298491)"
        required: true
        type: string
      luce:
        description: "Soglia luce in â‚¬/kWh (es. 0.25 oppure 0,25)"
        required: true
        type: string
      gas:
        description: "Soglia gas in â‚¬/Smc (es. 0.90 oppure 0,90)"
        required: true
        type: string

# ðŸ‘‡ fondamentale per abilitare git push dal workflow
permissions:
  contents: write

jobs:
  update-thresholds:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # mantiene le credenziali nel remote "origin" per il push
          persist-credentials: true
          ref: ${{ github.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Update soglie.json
        env:
          CHAT_ID: ${{ inputs.chat_id }}
          LUCE_IN: ${{ inputs.luce }}
          GAS_IN:  ${{ inputs.gas }}
        run: |
          python - << 'PY'
          import json, os, sys
          def to_float(s): return float(str(s).strip().replace(",", "."))
          path = "soglie.json"
          chat_id = str(os.environ["CHAT_ID"]).strip()
          try:
            luce = to_float(os.environ["LUCE_IN"])
            gas  = to_float(os.environ["GAS_IN"])
          except Exception as e:
            print("Valori non validi. Usa 0.25 o 0,25. Errore:", e); sys.exit(1)

          data = {
            "users": {},
            "default": {
              "luce": {"price": 0.25, "unit": "â‚¬/kWh"},
              "gas":  {"price": 0.90, "unit": "â‚¬/Smc"}
            }
          }
          try:
            with open(path, "r", encoding="utf-8") as f:
              data = json.load(f)
          except Exception:
            pass

          data.setdefault("users", {})
          data.setdefault("default", {
            "luce": {"price": 0.25, "unit": "â‚¬/kWh"},
            "gas":  {"price": 0.90, "unit": "â‚¬/Smc"}
          })

          user_cfg = data["users"].get(chat_id) or {
            "luce": {"price": data["default"]["luce"]["price"], "unit": "â‚¬/kWh"},
            "gas":  {"price": data["default"]["gas"]["price"],  "unit": "â‚¬/Smc"}
          }
          user_cfg["luce"]["price"] = float(luce)
          user_cfg["gas"]["price"]  = float(gas)
          data["users"][chat_id] = user_cfg

          with open(path, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)

          print(f"Aggiornato soglie.json per chat_id {chat_id} â†’ luce={luce} gas={gas}")
          PY

      - name: Commit & Push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # assicura di essere su lo stesso branch della run (es. main)
          CURRENT_BRANCH="${GITHUB_REF_NAME}"
          git checkout "${CURRENT_BRANCH}"

          git add soglie.json
          git commit -m "Update soglie per ${{ inputs.chat_id }} (luce=${{ inputs.luce }}, gas=${{ inputs.gas }})" || echo "Niente da commitare"

          # il checkout@v4 ha giÃ  le credenziali; questo push usa il GITHUB_TOKEN con contents:write
          git push origin "${CURRENT_BRANCH}"
