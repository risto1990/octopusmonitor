name: Set Soglie Manuale

on:
  workflow_dispatch:
    inputs:
      chat_id:
        description: "Il tuo chat_id Telegram (es. 32298491)"
        required: true
        type: string
      luce:
        description: "Soglia luce €/kWh (es. 0.25 oppure 0,25)"
        required: true
        type: string
      gas:
        description: "Soglia gas €/Smc (es. 0.90 oppure 0,90)"
        required: true
        type: string

# abilita il push dal workflow
permissions:
  contents: write

jobs:
  update-thresholds:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          ref: ${{ github.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Update soglie.json
        env:
          CHAT_ID: ${{ inputs.chat_id }}
          LUCE_IN: ${{ inputs.luce }}
          GAS_IN:  ${{ inputs.gas }}
        run: |
          python - << 'PY'
          import json, os, sys

          def to_float(s: str) -> float:
            # accetta "0,25" o "0.25"
            return float(str(s).strip().replace(",", "."))

          path = "soglie.json"
          chat_id = str(os.environ["CHAT_ID"]).strip()

          try:
            luce = to_float(os.environ["LUCE_IN"])
            gas  = to_float(os.environ["GAS_IN"])
          except Exception as e:
            print("Valori non validi. Usa 0.25 o 0,25. Errore:", e)
            sys.exit(1)

          # payload base
          data = {
            "users": {},
            "default": {
              "luce": {"price": 0.25, "unit": "€/kWh"},
              "gas":  {"price": 0.90, "unit": "€/Smc"}
            }
          }

          # carica se esiste
          try:
            with open(path, "r", encoding="utf-8") as f:
              data = json.load(f)
          except Exception:
            pass

          data.setdefault("users", {})
          data.setdefault("default", {
            "luce": {"price": 0.25, "unit": "€/kWh"},
            "gas":  {"price": 0.90, "unit": "€/Smc"}
          })

          # aggiorna/crea per chat_id
          user_cfg = data["users"].get(chat_id) or {
            "luce": {"price": data["default"]["luce"]["price"], "unit": "€/kWh"},
            "gas":  {"price": data["default"]["gas"]["price"],  "unit": "€/Smc"}
          }
          user_cfg["luce"]["price"] = float(luce)
          user_cfg["gas"]["price"]  = float(gas)
          data["users"][chat_id] = user_cfg

          with open(path, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)

          print(f"Aggiornato soglie.json per chat_id {chat_id} → luce={luce} gas={gas}")
          PY

      - name: Commit & Push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add soglie.json
          git commit -m "Update soglie per ${{ inputs.chat_id }} (luce=${{ inputs.luce }}, gas=${{ inputs.gas }})" || echo "Niente da commitare"
          git push
